variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: "tcp://docker:2375"
  MYSQL_ROOT_PASSWORD: app
  WEB_DOCUMENT_ROOT: $CI_PROJECT_DIR/development/public

stages:
- Static analyzes
- Testing

default:
  image: shopware/development:latest
  before_script:
  - zip -rq plugin.zip .
  - git clone --branch 6.0+ea http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/development.git
  - git clone --branch 6.0+ea http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/platform.git development/platform
  - unzip -q plugin.zip -d development/custom/plugins/SwagMigrationAssistant
  - cd development
  - cp -v dev-ops/gitlab/.psh.yaml.override .
  - /entrypoint supervisord > /dev/null 2>&1 &


# Stage: static

PHP analyze:
  stage: Static analyzes
  script:
  - composer install --no-interaction --optimize-autoloader --no-suggest --no-scripts
  - cd $CI_PROJECT_DIR/development/custom/plugins/SwagMigrationAssistant
  - bin/phpstan.sh
  - cd $CI_PROJECT_DIR/development
  - php vendor/shopware/platform/bin/php-cs-fixer.phar fix --config=vendor/shopware/platform/.php_cs.dist --dry-run -vvv --allow-risky=yes --format=junit custom/plugins/SwagMigrationAssistant > php-cs-fixer.xml
  artifacts:
    reports:
      junit: development/php-cs-fixer.xml

PHPUnit (MariaDB):
  stage: Testing
  services:
  -   name: mariadb:10.3
      alias: mysql
  script:
  - ./psh.phar init
  - php bin/console plugin:install --activate SwagMigrationAssistant
  - composer dump-autoload -d custom/plugins/SwagMigrationAssistant
  - ./psh.phar init-test-databases
  - php -d pcov.enabled=1
    vendor/bin/phpunit
    --configuration custom/plugins/SwagMigrationAssistant/phpunit.xml.dist
    --log-junit build/artifacts/phpunit.junit.xml
    --coverage-text
    --coverage-clover build/artifacts/phpunit.clover.xml
  coverage: '/^\s*Lines:\s*(\d+(?:\.\d+)?%)/'
  artifacts:
    reports:
      junit: development/build/artifacts/phpunit.junit.xml
